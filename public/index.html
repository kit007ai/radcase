<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <title>RadCase - Radiology Case Library</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/critical.css">
  <link rel="stylesheet" href="/mobile.css?v=4" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="/mobile.css?v=4"></noscript>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RadCase"><link rel="apple-touch-icon" href="/icon-apple-touch.png">
  <meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="RadCase">
  <meta name="HandheldFriendly" content="true"><meta name="MobileOptimized" content="320">
  <link rel="stylesheet" href="/styles/design-tokens.css?v=1">
  <link rel="stylesheet" href="/styles/base.css?v=4"><link rel="stylesheet" href="/styles/layout.css?v=4">
  <link rel="stylesheet" href="/styles/components.css?v=4"><link rel="stylesheet" href="/styles/views.css?v=4">
  <link rel="stylesheet" href="/styles/quiz.css?v=1">
  <link rel="stylesheet" href="/styles/case-library.css?v=1">
  <link rel="stylesheet" href="/styles/case-builder.css?v=1">
  <link rel="stylesheet" href="/styles/ai-tutor.css?v=1">
  <link rel="stylesheet" href="/styles/oral-boards.css?v=1">
  <link rel="stylesheet" href="/styles/milestones.css?v=1">
  <script src="https://unpkg.com/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://unpkg.com/cornerstone-core@2.6.1/dist/cornerstone.min.js"></script>
  <script src="https://unpkg.com/cornerstone-math@0.1.10/dist/cornerstoneMath.min.js"></script>
  <script src="https://unpkg.com/cornerstone-tools@6.0.10/dist/cornerstoneTools.min.js"></script>
  <script src="https://unpkg.com/dicom-parser@1.8.21/dist/dicomParser.min.js"></script>
  <script src="https://unpkg.com/cornerstone-wado-image-loader@4.13.2/dist/cornerstoneWADOImageLoader.bundle.min.js"></script>
  <script>
    cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
    cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
    cornerstoneTools.external.cornerstone = cornerstone;
    cornerstoneTools.external.cornerstoneMath = cornerstoneMath;
    cornerstoneTools.external.Hammer = Hammer;
    cornerstoneTools.init();
    cornerstoneWADOImageLoader.webWorkerManager.initialize({
      maxWebWorkers: navigator.hardwareConcurrency || 2,
      startWebWorkersOnDemand: true,
      taskConfiguration: { decodeTask: { initializeCodecsOnStartup: false, strict: false } }
    });
  </script>
</head>
<body>
  <header class="mobile-header">
    <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="Toggle menu">&#x2630;</button>
    <div class="mobile-logo">
      <div class="mobile-logo-icon">&#x1F3E5;</div>
      <h1>RadCase</h1>
    </div>
  </header>
  <div class="mobile-overlay" onclick="closeSidebar()"></div>
  <div class="app">
    <aside class="sidebar" role="complementary" aria-label="Navigation sidebar">
      <div class="logo">
        <div class="logo-icon">&#x1F3E5;</div>
        <div><h1>RadCase</h1><span>Teaching Case Library</span></div>
      </div>
      <nav class="nav" role="navigation" aria-label="Main navigation">
        <button class="nav-item active" data-page="library" aria-label="View case library" aria-current="page">
          <span class="icon" aria-hidden="true">&#x1F4DA;</span> Case Library
        </button>
        <button class="nav-item" data-page="add" aria-label="Add new case">
          <span class="icon" aria-hidden="true">&#x2795;</span> Add New Case
        </button>
        <button class="nav-item" data-page="case-builder" aria-label="AI Case Builder">
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
            </svg>
          </span> AI Case Builder
        </button>
        <button class="nav-item" data-page="quiz" aria-label="Quiz mode">
          <span class="icon" aria-hidden="true">&#x1F3AF;</span> Quiz Mode
        </button>
        <button class="nav-item" data-page="collections" aria-label="Collections">
          <span class="icon" aria-hidden="true">&#x1F4DA;</span> Collections
        </button>
        <button class="nav-item" data-page="analytics" aria-label="View analytics">
          <span class="icon" aria-hidden="true">&#x1F4CA;</span> Analytics
        </button>
        <button class="nav-item" data-page="oral-boards" aria-label="Oral Board Prep">
          <span class="icon" aria-hidden="true">&#x1F399;</span> Oral Boards
        </button>
        <button class="nav-item" data-page="milestones" aria-label="ACGME Milestones">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="vertical-align:middle;">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <span>Milestones</span>
        </button>
        <button class="nav-item nav-item-preferences" onclick="openPreferencesModal()" aria-label="Preferences">
          <span class="icon" aria-hidden="true">&#x2699;&#xFE0F;</span> Preferences
        </button>
      </nav>
      <div class="user-section" id="userSection">
        <div id="authButtons" class="auth-buttons">
          <button class="btn btn-primary btn-sm" onclick="showAuthModal('login')">&#x1F510; Sign In</button>
          <button class="btn btn-secondary btn-sm" onclick="showAuthModal('register')">&#x2728; Create Account</button>
        </div>
        <div id="userCard" class="user-card hidden">
          <div class="user-avatar" id="userAvatar">&#x1F464;</div>
          <div class="user-info">
            <div class="user-name" id="userName">-</div>
            <div class="user-role" id="userRole">-</div>
          </div>
          <button class="btn-icon" onclick="logout()" title="Sign out">&#x1F6AA;</button>
        </div>
      </div>
      <div class="stats-card" id="sidebarStats">
        <h3>Library Stats</h3>
        <div class="stat-row"><span>Total Cases</span><span class="stat-value" id="statCases">-</span></div>
        <div class="stat-row"><span>Images</span><span class="stat-value" id="statImages">-</span></div>
        <div class="stat-row"><span>Quiz Accuracy</span><span class="stat-value" id="statAccuracy">-</span></div>
      </div>
      <div class="stats-card hidden" id="progressCard" style="margin-top: 12px;">
        <h3>Your Progress</h3>
        <div class="stat-row"><span>Cases Studied</span><span class="stat-value" id="statStudied">-</span></div>
        <div class="stat-row"><span>Mastered</span><span class="stat-value" id="statMastered">-</span></div>
        <div class="stat-row"><span>Due for Review</span><span class="stat-value stat-due-warning" id="statDue">-</span></div>
      </div>
    </aside>

    <main class="main" role="main" aria-label="Main content">
      <!-- Library Page -->
      <section id="page-library" class="page">
        <div class="page-header"><h2>Case Library</h2><p>Browse and search your radiology teaching cases</p></div>
        <div class="search-bar" role="search" aria-label="Search and filter cases">
          <div class="search-input-wrapper">
            <span class="icon" aria-hidden="true">&#x1F50D;</span>
            <input type="text" class="search-input" id="searchInput" placeholder="Search cases..." aria-label="Search radiology cases" autocomplete="off">
          </div>
          <div class="filter-group">
            <select class="filter-select" id="filterModality" aria-label="Filter by modality"><option value="">All Modalities</option></select>
            <select class="filter-select" id="filterBodyPart" aria-label="Filter by body part"><option value="">All Body Parts</option></select>
            <select class="filter-select" id="filterDifficulty" aria-label="Filter by difficulty level">
              <option value="">All Difficulties</option>
              <option value="1">&#x2B50; Easy</option>
              <option value="2">&#x2B50;&#x2B50; Medium</option>
              <option value="3">&#x2B50;&#x2B50;&#x2B50; Hard</option>
              <option value="4">&#x2B50;&#x2B50;&#x2B50;&#x2B50; Expert</option>
              <option value="5">&#x2B50;&#x2B50;&#x2B50;&#x2B50;&#x2B50; Master</option>
            </select>
            <button class="bookmark-filter-btn" id="bookmarkFilterBtn" onclick="toggleBookmarkFilter()" aria-label="Show bookmarked cases only">
              <svg viewBox="0 0 24 24"><path class="heart-outline" d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
              Bookmarks
            </button>
          </div>
        </div>
        <div id="caseGrid" class="card-grid"></div>
      </section>

      <!-- Add Case Page -->
      <section id="page-add" class="page hidden">
        <div class="page-header"><h2>Add New Case</h2><p>Create a new teaching case for your library</p></div>
        <div class="card">
          <form id="addCaseForm">
            <div class="form-row">
              <div class="form-group"><label class="form-label">Case Title *</label><input type="text" class="form-input" name="title" required placeholder="e.g., Classic Pneumothorax"></div>
              <div class="form-group"><label class="form-label">Diagnosis *</label><input type="text" class="form-input" name="diagnosis" required placeholder="e.g., Right-sided pneumothorax"></div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Modality</label>
                <select class="form-select" name="modality">
                  <option value="">Select modality...</option>
                  <option value="X-Ray">X-Ray</option><option value="CT">CT</option><option value="MRI">MRI</option>
                  <option value="Ultrasound">Ultrasound</option><option value="Nuclear Medicine">Nuclear Medicine</option>
                  <option value="Fluoroscopy">Fluoroscopy</option><option value="Mammography">Mammography</option>
                  <option value="Angiography">Angiography</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Body Part</label>
                <select class="form-select" name="body_part">
                  <option value="">Select body part...</option>
                  <option value="Chest">Chest</option><option value="Abdomen">Abdomen</option><option value="Pelvis">Pelvis</option>
                  <option value="Head">Head</option><option value="Neck">Neck</option><option value="Spine">Spine</option>
                  <option value="Upper Extremity">Upper Extremity</option><option value="Lower Extremity">Lower Extremity</option>
                  <option value="Cardiac">Cardiac</option><option value="Breast">Breast</option><option value="MSK">MSK</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Difficulty (1-5)</label>
                <select class="form-select" name="difficulty">
                  <option value="1">1 - Easy</option><option value="2" selected>2 - Medium</option>
                  <option value="3">3 - Hard</option><option value="4">4 - Expert</option><option value="5">5 - Master</option>
                </select>
              </div>
            </div>
            <div class="form-group"><label class="form-label">Clinical History</label><textarea class="form-textarea" name="clinical_history" placeholder="Patient presentation, symptoms, relevant history..."></textarea></div>
            <div class="form-group"><label class="form-label">Key Findings</label><textarea class="form-textarea" name="findings" placeholder="Describe the radiological findings..."></textarea></div>
            <div class="form-group"><label class="form-label">Teaching Points</label><textarea class="form-textarea" name="teaching_points" placeholder="Important learning points for this case..."></textarea></div>
            <div class="form-group"><label class="form-label">Tags (comma separated)</label><input type="text" class="form-input" name="tags" placeholder="e.g., emergency, classic, must-know"></div>
            <div class="form-group">
              <label class="form-label">Images</label>
              <div class="upload-zone" id="uploadZone"><div class="icon">&#x1F4C1;</div><h3>Drop images here</h3><p>or click to browse - JPEG, PNG up to 50MB</p></div>
              <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
              <div class="image-grid" id="imagePreviewGrid"></div>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>
              <button type="submit" class="btn btn-primary">&#x1F4BE; Save Case</button>
            </div>
          </form>
        </div>
      </section>

      <!-- Case Builder Page -->
      <section id="page-case-builder" class="page hidden">
        <div class="page-header"><h2>AI Case Builder</h2><p>Generate teaching cases from radiology reports using AI</p></div>
        <div id="caseBuilderContainer"></div>
      </section>

      <!-- Quiz Hub Page -->
      <section id="page-quiz" class="page hidden">
        <div class="quiz-hub">
          <div id="quizHubHeader"></div>

          <div class="quiz-hub-modes" id="quizHubModes">
            <button class="quiz-hub-mode-btn" onclick="quizEngine.startDailyChallenge()">
              <span class="quiz-hub-mode-icon">&#x1F4C5;</span>Daily Challenge
            </button>
            <button class="quiz-hub-mode-btn" onclick="quizEngine.startQuickStudy()">
              <span class="quiz-hub-mode-icon">&#x26A1;</span>Quick Study
            </button>
            <button class="quiz-hub-mode-btn" onclick="quizEngine.startReviewDue()">
              <span class="quiz-hub-mode-icon">&#x1F504;</span>Review Due
            </button>
            <button class="quiz-hub-mode-btn" onclick="quizEngine.startWeaknessDrill()">
              <span class="quiz-hub-mode-icon">&#x1F3AF;</span>Weakness Drill
            </button>
          </div>

          <div class="quiz-hub-section" id="quizHubPlans">
            <h3>Your Study Plans</h3>
            <div id="quizPlansList"></div>
          </div>

          <div class="quiz-hub-section">
            <h3>Custom Session</h3>
            <div class="quiz-hub-filters">
              <select class="filter-select" id="quizModality"><option value="">All Modalities</option></select>
              <select class="filter-select" id="quizBodyPart"><option value="">All Body Parts</option></select>
              <select class="filter-select" id="quizDifficulty">
                <option value="">All Difficulties</option>
                <option value="1">Easy</option><option value="2">Medium</option><option value="3">Hard</option>
                <option value="4">Expert</option><option value="5">Master</option>
              </select>
            </div>
            <div class="quiz-hub-count-select">
              <button class="quiz-count-btn active" data-count="10">10 Qs</button>
              <button class="quiz-count-btn" data-count="20">20 Qs</button>
              <button class="quiz-count-btn" data-count="50">50 Qs</button>
            </div>
            <button class="btn btn-primary" onclick="startCustomQuiz()" style="width:100%">Start Session</button>
          </div>

          <div class="quiz-hub-section" id="quizHubBadges">
            <h3>Recent Badges</h3>
            <div id="quizBadgeShelf"></div>
          </div>

          <div class="quiz-hub-section" id="quizHubLeaderboard" style="display:none;">
            <h3>Leaderboard</h3>
            <div id="quizLeaderboardContent"></div>
          </div>
        </div>
      </section>

      <!-- Collections Page -->
      <section id="page-collections" class="page hidden">
        <div class="page-header"><h2>Collections</h2><p>Curated playlists and custom case collections</p></div>
        <div id="collectionsContent"></div>
      </section>

      <!-- Analytics Dashboard Page -->
      <section id="page-analytics" class="page hidden">
        <div class="page-header"><h2>Analytics</h2><p>Deep performance insights and board readiness</p></div>
        <div id="analyticsDashboard"></div>
      </section>

      <!-- Oral Board Prep Page -->
      <section id="page-oral-boards" class="page hidden">
        <div class="page-header"><h2>Oral Board Prep</h2><p>AI-powered ABR oral board simulation</p></div>
        <div id="oralBoardsContainer"></div>
      </section>

      <!-- Milestones Page -->
      <section id="page-milestones" class="page hidden">
        <div class="page-header">
          <h2>ACGME Milestones</h2>
        </div>
        <div id="milestonesContainer"></div>
      </section>

      <!-- Program Dashboard Page -->
      <section id="page-program-dashboard" class="page hidden">
        <div class="page-header">
          <h2>Program Dashboard</h2>
        </div>
        <div id="programDashboardContainer"></div>
      </section>
    </main>
  </div>

  <!-- Case View Modal -->
  <div class="modal-overlay" id="caseModal">
    <button class="modal-nav-btn modal-nav-prev" onclick="navigateCase(-1)" title="Previous case">&#x2039;</button>
    <button class="modal-nav-btn modal-nav-next" onclick="navigateCase(1)" title="Next case">&#x203A;</button>
    <div class="modal modal-case">
      <div class="modal-header">
        <h2 id="modalTitle">Case Details</h2>
        <button class="modal-bookmark-btn" id="modalBookmarkBtn" onclick="toggleModalBookmark()" aria-label="Bookmark this case" title="Bookmark">
          <svg viewBox="0 0 24 24"><path class="heart-outline" d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          <span id="modalBookmarkLabel">Bookmark</span>
        </button>
        <button class="voice-narrate-btn" id="voiceNarrateBtn" onclick="toggleVoiceNarration()" title="Read case aloud" aria-label="Read case aloud">
          <span class="voice-narrate-icon">&#x1F50A;</span>
        </button>
        <div class="viewer-mode-switch" id="viewerModeSwitch">
          <button class="mode-btn" data-mode="reference" onclick="window.toggleViewerMode('reference')" title="See all case details immediately">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
            Reference
          </button>
          <button class="mode-btn active" data-mode="study" onclick="window.toggleViewerMode('study')" title="Progressive reveal with differential practice">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            Study Mode
          </button>
        </div>
        <div class="modal-tabs hidden" id="viewerTabs">
          <button class="tab-btn active" data-tab="images" onclick="switchViewerTab('images')">&#x1F4F7; Images</button>
          <button class="tab-btn" data-tab="dicom" onclick="switchViewerTab('dicom')">&#x1F52C; DICOM</button>
        </div>
        <button class="modal-close" onclick="closeModal()">&#x2715;</button>
      </div>
      <div class="study-step-indicator" id="studyStepIndicator" style="display:none;">
        <div class="study-step active" data-step="0"><span class="study-step-dot"></span>History</div>
        <div class="study-step-connector"></div>
        <div class="study-step" data-step="1"><span class="study-step-dot"></span>Images</div>
        <div class="study-step-connector"></div>
        <div class="study-step" data-step="2"><span class="study-step-dot"></span>Differential</div>
        <div class="study-step-connector"></div>
        <div class="study-step" data-step="3"><span class="study-step-dot"></span>Reveal</div>
        <div class="study-step-connector"></div>
        <div class="study-step" data-step="4"><span class="study-step-dot"></span>Teaching</div>
      </div>
      <div class="modal-body">
        <div class="case-view">
          <div class="viewer-container">
            <div id="imageViewerPanel">
              <div class="case-viewer" id="caseViewerImageWrap"><img id="modalMainImage" src="" alt="Case image"></div>
              <div class="case-thumbnails" id="modalThumbnails"></div>
            </div>
            <div id="dicomViewerPanel" class="hidden">
              <div class="dicom-series-selector" id="dicomSeriesSelector"></div>
              <div id="dicomViewerContainer" class="dicom-viewer-area"></div>
            </div>
            <div class="dicom-upload-section" id="dicomUploadSection">
              <details>
                <summary>&#x1F4E4; Upload DICOM Series</summary>
                <div class="dicom-upload-inner">
                  <input type="file" id="dicomFileInput" multiple accept=".dcm,application/dicom" class="hidden">
                  <input type="file" id="dicomFolderInput" webkitdirectory directory multiple class="hidden">
                  <button class="btn btn-secondary btn-sm" onclick="document.getElementById('dicomFileInput').click()">Select Files</button>
                  <button class="btn btn-secondary btn-sm" onclick="document.getElementById('dicomFolderInput').click()" style="margin-left: 8px;">&#x1F4C1; Select Folder</button>
                  <span id="dicomFileCount" style="margin-left: 12px; color: var(--text-muted);"></span>
                  <button class="btn btn-primary btn-sm hidden" id="uploadDicomBtn" style="margin-left: 12px;" onclick="uploadDicomFiles()">Upload</button>
                </div>
              </details>
            </div>
          </div>
          <div class="case-details">
            <div class="case-meta" id="modalMeta"></div>
            <div class="detail-section"><h3>Clinical History</h3><div class="detail-content" id="modalHistory">-</div></div>
            <div class="detail-section"><h3>Diagnosis</h3><div class="detail-content detail-diagnosis" id="modalDiagnosis">-</div></div>
            <div class="detail-section"><h3>Key Findings</h3><div class="detail-content" id="modalFindings">-</div></div>
            <div class="detail-section"><h3>Teaching Points</h3><div class="detail-content" id="modalTeaching">-</div></div>
            <div class="detail-section" id="levelNotesSection" style="display:none;"><div class="level-notes-callout" id="levelNotesCallout"></div></div>
            <div id="differentialInputArea" style="display:none;"></div>
            <div id="relatedCasesArea"></div>
            <div id="discussionArea"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger btn-sm" onclick="deleteCase()">&#x1F5D1;&#xFE0F; Delete</button>
        <button class="btn btn-secondary" onclick="annotateCase()">&#x270F;&#xFE0F; Annotate</button>
        <button class="btn btn-secondary" onclick="collectionsManager.showAddToCollectionPicker(state.currentCase?.id)">&#x1F4DA; Add to Collection</button>
        <button class="btn btn-primary" onclick="presentCase()">&#x1F3AC; Present</button>
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Annotation Modal -->
  <div class="modal-overlay" id="annotationModal">
    <div class="modal modal-annotation">
      <div class="modal-header"><h2>Annotate Image</h2><button class="modal-close" onclick="closeAnnotationModal()">&#x2715;</button></div>
      <div class="modal-body"><div id="annotationContainer" class="annotation-container"></div></div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <!-- Auth Modal -->
  <div class="auth-modal" id="authModal">
    <div class="auth-box">
      <button class="modal-close" onclick="closeAuthModal()">&#x2715;</button>
      <div class="auth-header"><h2>&#x1F3E5; RadCase</h2><p>Track your learning progress</p></div>
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
        <button class="auth-tab" onclick="switchAuthTab('register')">Create Account</button>
      </div>
      <div class="auth-error" id="authError"></div>
      <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group"><label class="form-label">Username or Email</label><input type="text" class="form-input" name="username" required autocomplete="username"></div>
        <div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" name="password" required autocomplete="current-password"></div>
        <button type="submit" class="btn btn-primary auth-submit">Sign In</button>
      </form>
      <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
        <div class="form-group"><label class="form-label">Username *</label><input type="text" class="form-input" name="username" required autocomplete="username" pattern="[a-zA-Z0-9_]+" title="Letters, numbers, and underscores only"></div>
        <div class="form-group"><label class="form-label">Display Name</label><input type="text" class="form-input" name="displayName" autocomplete="name" placeholder="How should we call you?"></div>
        <div class="form-group"><label class="form-label">Email (optional)</label><input type="email" class="form-input" name="email" autocomplete="email"></div>
        <div class="form-group"><label class="form-label">Password *</label><input type="password" class="form-input" name="password" required autocomplete="new-password" minlength="4" placeholder="At least 4 characters"></div>
        <div class="form-group">
          <label class="form-label">I am a...</label>
          <div class="trainee-level-selector" id="registerTraineeLevel">
            <button type="button" class="trainee-level-btn" data-level="student" onclick="selectTraineeLevel(this)">Medical Student</button>
            <button type="button" class="trainee-level-btn active" data-level="resident" onclick="selectTraineeLevel(this)">Resident</button>
            <button type="button" class="trainee-level-btn" data-level="fellow" onclick="selectTraineeLevel(this)">Fellow</button>
            <button type="button" class="trainee-level-btn" data-level="attending" onclick="selectTraineeLevel(this)">Attending</button>
          </div>
          <input type="hidden" name="traineeLevel" value="resident">
        </div>
        <button type="submit" class="btn btn-primary auth-submit">Create Account</button>
      </form>
      <div class="guest-link"><a href="#" onclick="closeAuthModal(); return false;">Continue as guest &#x2192;</a></div>
    </div>
  </div>

  <!-- Preferences Modal -->
  <div class="preferences-overlay" id="preferencesOverlay">
    <div class="preferences-modal">
      <div class="modal-header">
        <h2>Preferences</h2>
        <button class="modal-close" onclick="closePreferencesModal()" aria-label="Close preferences">&#x2715;</button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label" for="prefViewMode">Default View Mode</label><select class="form-select" id="prefViewMode"><option value="grid">Grid</option><option value="list">List</option></select></div>
        <div class="form-group"><label class="form-label" for="prefFontSize">Font Size</label><select class="form-select" id="prefFontSize"><option value="small">Small</option><option value="medium" selected>Medium</option><option value="large">Large</option></select></div>
        <div class="form-group">
          <label class="form-label">Annotation Default Color</label>
          <div class="pref-color-swatches" id="prefColorSwatches">
            <button type="button" class="pref-color-swatch selected" data-color="#ff3b30" style="background:#ff3b30;" aria-label="Red" title="Red"></button>
            <button type="button" class="pref-color-swatch" data-color="#ff9500" style="background:#ff9500;" aria-label="Orange" title="Orange"></button>
            <button type="button" class="pref-color-swatch" data-color="#ffcc00" style="background:#ffcc00;" aria-label="Yellow" title="Yellow"></button>
            <button type="button" class="pref-color-swatch" data-color="#34c759" style="background:#34c759;" aria-label="Green" title="Green"></button>
            <button type="button" class="pref-color-swatch" data-color="#007aff" style="background:#007aff;" aria-label="Blue" title="Blue"></button>
            <button type="button" class="pref-color-swatch" data-color="#af52de" style="background:#af52de;" aria-label="Purple" title="Purple"></button>
            <button type="button" class="pref-color-swatch" data-color="#ffffff" style="background:#ffffff;" aria-label="White" title="White"></button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="prefTraineeLevel">Trainee Level</label>
          <select class="form-select" id="prefTraineeLevel">
            <option value="student">Medical Student</option>
            <option value="resident" selected>Resident</option>
            <option value="fellow">Fellow</option>
            <option value="attending">Attending</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label" for="prefTheme">Theme</label><select class="form-select" id="prefTheme"><option value="auto">Auto</option><option value="dark" selected>Dark</option><option value="light">Light</option></select></div>
        <div class="preferences-actions">
          <button class="btn btn-secondary btn-sm" onclick="resetPreferences()">Reset Defaults</button>
          <button class="btn btn-primary btn-sm" onclick="savePreferencesAndClose()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="offline-indicator" id="offlineIndicator">You are offline - some features may be limited</div>

  <nav class="mobile-bottom-nav" id="mobileBottomNav" aria-label="Mobile navigation">
    <div class="bottom-nav-items">
      <button class="bottom-nav-item active" data-page="library" aria-label="Case Library"><span class="nav-icon" aria-hidden="true">&#x1F4DA;</span>Library</button>
      <button class="bottom-nav-item" data-page="add" aria-label="Add Case"><span class="nav-icon" aria-hidden="true">&#x2795;</span>Add</button>
      <button class="bottom-nav-item" data-page="quiz" aria-label="Quiz Mode"><span class="nav-icon" aria-hidden="true">&#x1F3AF;</span>Quiz</button>
      <button class="bottom-nav-item" data-page="collections" aria-label="Collections"><span class="nav-icon" aria-hidden="true">&#x1F4DA;</span>Collections</button>
      <button class="bottom-nav-item" data-page="analytics" aria-label="Analytics"><span class="nav-icon" aria-hidden="true">&#x1F4CA;</span>Stats</button>
    </div>
  </nav>

  <button class="micro-learning-fab" id="microLearningFab" onclick="quizEngine.startQuickStudy()" aria-label="Quick Study" title="Start Quick Study Session">&#x26A1;</button>

  <script src="/lazy-loader.js?v=4"></script><script src="/performance-optimizer.js?v=4"></script><script src="/pwa-manager.js?v=4"></script>
  <script src="/annotate.js?v=4" defer></script><script src="/presentation.js?v=4" defer></script>
  <script src="/spaced-repetition.js?v=4" defer></script><script src="/dicom-viewer.js?v=4" defer></script>
  <script src="/sync-manager.js?v=4" defer></script><script src="/touch-gestures.js?v=4" defer></script>
  <script src="/quiz-engine.js?v=1" defer></script>
  <script src="/quiz-cards.js?v=1" defer></script>
  <script src="/quiz-gamification.js?v=1" defer></script>
  <script src="/quiz-study-plans.js?v=1" defer></script>
  <script src="/analytics-dashboard.js?v=1" defer></script>
  <script src="/finding-quiz.js?v=1" defer></script>
  <script src="/voice-narrator.js?v=4" defer></script>
  <script src="/case-viewer.js?v=1" defer></script>
  <script src="/differential-input.js?v=1" defer></script>
  <script src="/key-findings-overlay.js?v=1" defer></script>
  <script src="/discussions.js?v=1" defer></script>
  <script src="/related-cases.js?v=1" defer></script>
  <script src="/collections.js?v=1" defer></script>
  <script src="/case-builder.js?v=1" defer></script>
  <script src="/ai-tutor.js?v=1" defer></script>
  <script src="/study-ai-overlay.js?v=1" defer></script>
  <script src="/weakness-coach.js?v=1" defer></script>
  <script src="/oral-boards.js?v=1" defer></script>
  <script src="/milestones.js?v=1" defer></script>
  <script src="/program-dashboard.js?v=1" defer></script>
  <script type="module" src="/app.js?v=6"></script>
</body>
</html>
